<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Upload Exposure CSV</title>
  <link rel="icon" type="image/svg+xml" href="favicon.svg" />
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <link rel="stylesheet" href="portfolio.css">
</head>
<body>
  <div id="portfolio-wrapper">
    <div id="portfolio-controls">
      <div id="upload-container">
        <h1>Upload Exposure CSV</h1>
        <label id="open-modal" class="upload-btn">Upload Exposure CSV</label>
        <button id="clear-lineups" class="upload-btn" style="display:none;">Clear Lineups</button>
        <div id="message"></div>
      </div>
      <div id="last-query-container">
        <p class="last-query-title">Last SQL Query:</p>
        <pre id="last-query"></pre>
      </div>
      <div id="format-options" style="display:none;">
        <p class="info-note">Showing Teams Drafted in the Following Formats:</p>
        <label id="label-pre" class="format-option"><img class="icon" src="https://encrypted-tbn0.gstatic.com/images?q=tbn:ANd9GcRltuDZN3yIMK1sh9oDF7ykc7HYDeuCGoZ--g&s" alt="Underdog logo"><input type="checkbox" id="chk-pre"> Pre-Draft</label>
        <label id="label-post" class="format-option"><img class="icon" src="https://encrypted-tbn0.gstatic.com/images?q=tbn:ANd9GcRltuDZN3yIMK1sh9oDF7ykc7HYDeuCGoZ--g&s" alt="Underdog logo"><input type="checkbox" id="chk-post"> Post-Draft</label>
        <label id="label-elim" class="format-option"><img class="icon" src="https://encrypted-tbn0.gstatic.com/images?q=tbn:ANd9GcRltuDZN3yIMK1sh9oDF7ykc7HYDeuCGoZ--g&s" alt="Underdog logo"><input type="checkbox" id="chk-elim"> Eliminator</label>
      </div>
      <div id="date-filter" style="display:none;">
        <label>Draft Date:
          <input type="date" id="start-date" min="2025-01-01">
          <span>&ndash;</span>
          <input type="date" id="end-date" min="2025-01-01">
        </label>
      </div>
      <div id="sort-control" style="display:none;">
        <label>Ratings Sort:
          <button id="sort-toggle" aria-label="Toggle ratings sort">
            &#8595;
          </button>
        </label>
      </div>
      <div id="view-control" style="display:none;">
        <label>View Mode:
          <button id="view-card" class="view-toggle selected" aria-label="Card view">
            <i class="fa-solid fa-th-large" aria-hidden="true"></i>
          </button>
          <button id="view-list" class="view-toggle" aria-label="List view">
            <i class="fa-solid fa-list" aria-hidden="true"></i>
          </button>
        </label>
      </div>
    </div>
    <div id="teams"></div>
    <div id="pagination"></div>
  </div>

  <button id="exposureFab" role="button" tabindex="0" aria-label="Open player exposure drawer" class="exposure-fab">
    <i class="fa-solid fa-chart-pie" aria-hidden="true"></i>
    <span class="fa-fallback">EXP</span>
  </button>
  <aside id="exposureDrawer" aria-hidden="true">
    <div class="drawer-header">
      <h3>Player Exposure</h3>
      <button class="drawer-close" aria-label="Close player exposure drawer"><i class="fa-solid fa-chevron-right" aria-hidden="true"></i></button>
    </div>
    <div class="drawer-body">
      <table id="exposure-table" class="player-table">
        <thead><tr><th>Player</th><th>#</th><th>%</th></tr></thead>
        <tbody></tbody>
      </table>
    </div>
  </aside>
  <div id="exposureScrim" tabindex="-1" aria-hidden="true"></div>

  <div id="upload-modal" class="modal">
    <div class="modal-content">
      <h2>Select CSVs to Upload</h2>
      <div class="upload-row">
        <span>Pre-Draft (Underdog)</span>
        <label for="pre-file" class="browse-btn">Browse</label>
        <input type="file" id="pre-file" accept=".csv">
        <progress id="pre-progress" max="100" value="0" class="upload-progress" style="display:none;"></progress>
        <span id="pre-status" class="status"></span>
      </div>
      <div class="upload-row">
        <span>Post-Draft (Underdog)</span>
        <label for="post-file" class="browse-btn">Browse</label>
        <input type="file" id="post-file" accept=".csv">
        <progress id="post-progress" max="100" value="0" class="upload-progress" style="display:none;"></progress>
        <span id="post-status" class="status"></span>
      </div>
      <div class="upload-row">
        <span>Eliminator</span>
        <label for="elim-file" class="browse-btn">Browse</label>
        <input type="file" id="elim-file" accept=".csv">
        <progress id="elim-progress" max="100" value="0" class="upload-progress" style="display:none;"></progress>
        <span id="elim-status" class="status"></span>
      </div>
      <div id="db-status" class="status"></div>
      <button id="upload-done">Done</button>
      <div id="insert-count" class="status"></div>
      <pre id="db-query" class="db-query"></pre>
    </div>
  </div>
  <div id="query-modal" class="modal">
    <div class="modal-content">
      <h2>SQL Query</h2>
      <pre id="query-content"></pre>
      <button id="query-done">Done</button>
    </div>
  </div>
  <div id="share-modal" class="modal">
    <div class="modal-content">
      <h2>Share Lineup</h2>
      <img id="share-image" alt="Share preview" style="max-width:100%;height:auto;">
      <button id="share-close">Close</button>
    </div>
  </div>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js"></script>
  <script src="supabase.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>

  <script>
    const requiredHeaders = [
      "Picked At","Pick Number","Appearance","First Name","Last Name","Team","Position","Draft","Draft Entry","Draft Entry Fee","Draft Size","Draft Total Prizes","Tournament Title","Tournament","Tournament Entry Fee","Tournament Total Prizes","Tournament Size","Draft Pool Title","Draft Pool","Draft Pool Entry Fee","Draft Pool Total Prizes","Draft Pool Size","Weekly Winner Title","Weekly Winner","Weekly Winner Entry Fee","Weekly Winner Total Prizes","Weekly Winner Size"
    ];

    const sheetId = '1rNouBdE-HbWafu-shO_5JLPSrLhr-xuGpXYfyOI-2oY';
    const rankingsUrl = `https://opensheet.elk.sh/${sheetId}/Rankings`;
      const sentimentUrl = `https://opensheet.elk.sh/${sheetId}/Sentiment`;

      const dbStatusEl = document.getElementById('db-status');
      const dbQueryEl = document.getElementById('db-query');
      const insertCountEl = document.getElementById('insert-count');
      const lastQueryEl = document.getElementById('last-query');
      let lastSqlQuery = '';
      let lastInsertCount = 0;
      if(dbQueryEl) dbQueryEl.style.display='none';
      function updateLastQueryDisplay(){
        if(lastQueryEl) lastQueryEl.textContent=lastSqlQuery;
      }
      const savedQuery = localStorage.getItem('bb_lastQuery');
      if(savedQuery){
        lastSqlQuery = savedQuery;
        updateLastQueryDisplay();
      }

    function canonicalName(name){return (name||'').toString().toLowerCase().replace(/[.'â€™]/g,'').replace(/[^a-z0-9]+/g,' ').trim();}
    function canonicalField(name){return (name||'').toString().toLowerCase().replace(/[^a-z0-9]/g,'');}

    function getFantasyPoints(row){
      if(row.I||row['Fantasy Points']||row['FantasyPts']) return row.I||row['Fantasy Points']||row['FantasyPts'];
      const key=Object.keys(row).find(k=>{const ck=canonicalField(k);return ck.includes('fantasypoints')||ck.includes('fantasypts');});
      return key?row[key]:'';
    }

    function getColumn(row,letter,labelPart){
      if(row[letter]) return row[letter];
      const target=canonicalField(labelPart);
      const key=Object.keys(row).find(k=>canonicalField(k).includes(target));
      return key?row[key]:'';
    }

    const ratingMap={};

    const positiveEmojis=['ðŸ˜ƒ','ðŸš€','ðŸ’°','ðŸ’µ','ðŸ™Œ'];
    const neutralEmojis=['ðŸ˜','ðŸ¤”','ðŸ§','ðŸ¤·','ðŸ˜‘'];
    const negativeEmojis=['ðŸ˜ž','ðŸ‘Ž','â˜ ï¸','ðŸ”¥','ðŸ†˜'];
    const teamMap={JAX:'JAC'};

    function pickEmoji(arr){return arr[Math.floor(Math.random()*arr.length)];}

    function colorForPct(pct){
      const hue=pct>=66?120:pct>=34?60:0;
      const light=90-(Math.min(pct,100)/100)*50;
      const bg=`hsl(${hue},70%,${light}%)`;
      const text=light<60?'#fff':'#000';
      return {bg,text};
    }

    const ratingsPromise=loadRatings();

    async function loadRatings(){
      try{
        const[rankRes,sentRes]=await Promise.all([fetch(rankingsUrl),fetch(sentimentUrl)]);
        const rankings=await rankRes.json();
        const sentimentRows=await sentRes.json();
        const sentimentMap={};
        sentimentRows.forEach(r=>{const playerName=canonicalName(r.Player||r.player);const score=r.Sentiment||r['Sentiment Score']||r.F||'';if(playerName)sentimentMap[playerName]=score;});
        const rowsData=rankings.map(row=>{const player=row.Player||row.player;const canon=canonicalName(player);const rowSentiment=row.Sentiment||row['Sentiment Score']||row.H||'';const sentiment=rowSentiment||sentimentMap[canon]||'';let adp=row.J||row.ADP||row['ADP']||'';let adpPct=getColumn(row,'L','adp percentile');const isUndrafted=adp.toString().toLowerCase()==='undrafted'||adp==='#N/A'||adp==='-'||adpPct==='#N/A'||adpPct==='#VALUE!'||adpPct==='';if(isUndrafted){adp='Undrafted';adpPct='0.00';}const fantasyPts=getFantasyPoints(row);const wmonigheRank=getColumn(row,'G','wmonighe rank');return{player,sentimentValue:parseFloat(sentiment),adpPct,wmonigheRank,vorpPct:getColumn(row,'R','vorp percentile'),fantasyPts};});
        const numericFps=rowsData.map(r=>parseFloat(r.fantasyPts)).filter(v=>!isNaN(v)).sort((a,b)=>a-b);
        rowsData.forEach(r=>{const val=parseFloat(r.fantasyPts);if(!isNaN(val)&&numericFps.length){const rank=numericFps.filter(v=>v<=val).length;r.fpPct=(rank/numericFps.length).toFixed(2);}else{r.fpPct='';}});
        rowsData.forEach(r=>{const rankVal=parseFloat(r.wmonigheRank);if(!isNaN(rankVal)){let pct=(300-rankVal)/299;if(rankVal>=300)pct=0;if(pct>1)pct=1;if(pct<0)pct=0;r.wmonighePct=pct.toFixed(2);}else{r.wmonighePct='';}});
        rowsData.forEach(r=>{const val=parseFloat(r.vorpPct);r.vorpPct=!isNaN(val)?parseFloat(val).toFixed(2):'';});
        const numericSentiments=rowsData.map(r=>r.sentimentValue).filter(v=>!isNaN(v));
        const minSentiment=numericSentiments.length?Math.min(...numericSentiments):0;
        const maxSentiment=numericSentiments.length?Math.max(...numericSentiments):0;
        const range=maxSentiment-minSentiment||1;
        rowsData.forEach(r=>{if(!isNaN(r.sentimentValue)){const pctRaw=(r.sentimentValue-minSentiment)/range;r.sentimentPct=pctRaw.toFixed(2);}else{r.sentimentPct='';}});
        const weights={wmonighe:0.35,adp:0.35,fp:0.1,sentiment:0.05,vorp:0.15};
        rowsData.forEach(r=>{const items=[{v:parseFloat(r.wmonighePct),w:weights.wmonighe},{v:parseFloat(r.adpPct),w:weights.adp},{v:parseFloat(r.fpPct),w:weights.fp},{v:parseFloat(r.sentimentPct),w:weights.sentiment},{v:parseFloat(r.vorpPct),w:weights.vorp}].filter(i=>!isNaN(i.v)&&i.w>0);const totalWeight=items.reduce((a,b)=>a+b.w,0);let rating='';if(items.length&&totalWeight>0){const sum=items.reduce((s,i)=>s+i.v*i.w,0);rating=(sum/totalWeight).toFixed(2);}ratingMap[canonicalName(r.player)]=rating;});
      }catch(err){console.error('Error loading ratings',err);}
    }

    const allTeams=[];
    const uploadedFormats={pre:false,post:false,elim:false};
    let sortOrder='desc';
    let viewMode='card';
    let uploading=false;
    let currentPage=1;
    let pageSize=21;
    let filteredTeams=[];

    function saveUploads(){
      try{
        localStorage.setItem('bb_allTeams',JSON.stringify(allTeams));
        localStorage.setItem('bb_uploadedFormats',JSON.stringify(uploadedFormats));
      }catch(err){
        console.error('Error saving uploads',err);
      }
    }

    function loadUploads(){
      try{
        const teamsStr=localStorage.getItem('bb_allTeams');
        const formatsStr=localStorage.getItem('bb_uploadedFormats');
        if(teamsStr&&formatsStr){
          const savedTeams=JSON.parse(teamsStr);
          const savedFormats=JSON.parse(formatsStr);
          if(Array.isArray(savedTeams)&&savedFormats){
            savedTeams.forEach(t=>{if(t.draftDate)t.draftDate=new Date(t.draftDate);allTeams.push(t);});
            uploadedFormats.pre=!!savedFormats.pre;
            uploadedFormats.post=!!savedFormats.post;
            uploadedFormats.elim=!!savedFormats.elim;
          }
        }
      }catch(err){
        console.error('Error loading uploads',err);
      }
    }

    function updateFormatOptions(){
      const container=document.getElementById('format-options');
      const preLabel=document.getElementById('label-pre');
      const postLabel=document.getElementById('label-post');
      const elimLabel=document.getElementById('label-elim');
      const dateFilter=document.getElementById('date-filter');
      const sortControl=document.getElementById('sort-control');
      const viewControl=document.getElementById('view-control');
      const anyUploaded=uploadedFormats.pre||uploadedFormats.post||uploadedFormats.elim;
      container.style.display=anyUploaded?'block':'none';
      if(dateFilter) dateFilter.style.display=anyUploaded?'block':'none';
      if(sortControl) sortControl.style.display=anyUploaded?'block':'none';
      if(viewControl) viewControl.style.display=anyUploaded?'block':'none';
      if(anyUploaded&&dateFilter){
        const startInput=document.getElementById('start-date');
        const endInput=document.getElementById('end-date');
        const today=new Date().toISOString().split('T')[0];
        if(!startInput.value) startInput.value='2025-01-01';
        if(!endInput.value) endInput.value=today;
        startInput.max=today;
        endInput.max=today;
      }
      preLabel.style.display=uploadedFormats.pre?'inline-flex':'none';
      postLabel.style.display=uploadedFormats.post?'inline-flex':'none';
      elimLabel.style.display=uploadedFormats.elim?'inline-flex':'none';
      if(uploadedFormats.pre) document.getElementById('chk-pre').checked=true;
      if(uploadedFormats.post) document.getElementById('chk-post').checked=true;
      if(uploadedFormats.elim) document.getElementById('chk-elim').checked=true;
      const uploadContainer=document.getElementById('upload-container');
      const uploadBtn=document.getElementById('open-modal');
      const clearBtn=document.getElementById('clear-lineups');
      const uploadTitle=uploadContainer.querySelector('h1');
      if(anyUploaded){
        uploadContainer.classList.add('uploaded');
        uploadBtn.textContent='Upload More';
        if(clearBtn) clearBtn.style.display='inline-block';
        if(uploadTitle) uploadTitle.style.display='none';
      }else{
        uploadContainer.classList.remove('uploaded');
        uploadBtn.textContent='Upload Exposure CSV';
        if(clearBtn) clearBtn.style.display='none';
        if(uploadTitle) uploadTitle.style.display='block';
      }
      const controls=document.getElementById('portfolio-controls');
      if(controls){
        if(anyUploaded) controls.classList.add('with-uploads');
        else controls.classList.remove('with-uploads');
      }
    }

    function setUploading(state){
      uploading=state;
      ['pre-file','post-file','elim-file'].forEach(id=>{
        const el=document.getElementById(id);
        if(el) el.disabled=state;
      });
    }

      async function uploadRowsToSupabase(rows,format,progressCb){
        try{
          const allowed=['pre','post','elim'];
          if(!allowed.includes(format)) return false;
          if(typeof supabase==='undefined') return false;
          let success=true;
          lastInsertCount=0;

          const entryIds=[...new Set(rows.map(r=>r['Draft Entry']).filter(v=>v))];
          if(entryIds.length){
            const {data:existing,error:selectErr}=await supabase
              .from('underdog_draft_upload')
              .select('"Draft Entry"')
              .in('"Draft Entry"',entryIds);
            if(selectErr){
              console.error('Supabase fetch error',selectErr);
            }else if(existing){
              const existingSet=new Set(existing.map(e=>e['Draft Entry']));
              rows=rows.filter(r=>!existingSet.has(r['Draft Entry']));
            }
          }

          lastInsertCount = rows.length;

          for(let i=0;i<rows.length;i+=500){
            const batch=rows.slice(i,i+500);
            const first=batch[0];
            if(first){
              const keys=Object.keys(first);
              const values=keys.map(k=>{
                const v=first[k];
                if(v===null||v===undefined||v==='') return 'NULL';
                if(typeof v==='number') return v;
                return `'${v.toString().replace(/'/g,"''")}'`;
              }).join(', ');
              const quoted=keys.map(k=>`"${k}"`).join(', ');
              lastSqlQuery=`INSERT INTO underdog_draft_upload (${quoted}) VALUES (${values});`;
            }
            const {error}=await supabase
              .from('underdog_draft_upload')
              .insert(batch);
            if(error){
              console.error('Supabase upload error',error);
              success=false;
            }
            if(progressCb){
              const pct=Math.min(100,Math.round(((i+batch.length)/rows.length)*100));
              progressCb(pct);
            }
          }
          if(!success) lastInsertCount = 0;
          return success;
        }catch(err){
          console.error('Supabase upload error',err);
          return false;
        }
      }

    async function handleFile(file,statusEl,format,progressEl){
      if(!file) return false;
      await ratingsPromise;
      try{
        if(statusEl){statusEl.textContent='Uploading...';statusEl.className='status';}
        const text=await file.text();
        const lines=text.trim().split(/\r?\n/).filter(l=>l.trim()!=='');
        const headers=lines[0].split(',').map(h=>h.trim());
        const allPresent=requiredHeaders.every(h=>headers.includes(h));
        if(!allPresent){statusEl.textContent='\u2717 Upload Failure';statusEl.className='status error';return false;}
        const intFields=[
          'Pick Number','Draft Size','Tournament Size','Draft Pool Size','Weekly Winner Size'
        ];
        const floatFields=[
          'Draft Entry Fee','Draft Total Prizes','Tournament Entry Fee','Tournament Total Prizes',
          'Draft Pool Entry Fee','Draft Pool Total Prizes','Weekly Winner Entry Fee','Weekly Winner Total Prizes'
        ];
        const uuidFields=[
          'Appearance','Draft','Draft Entry','Tournament','Draft Pool','Weekly Winner'
        ];
        const rows=lines.slice(1).map(line=>{
          const values=line.split(',').map(v=>v.trim());
          const obj={};
          headers.forEach((h,i)=>{
            let val=values[i];
            if((intFields.includes(h)||floatFields.includes(h)||uuidFields.includes(h)||h==='Picked At') && val==='') val=null;
            if(intFields.includes(h)&&val!==null){
              const n=parseInt(val,10);val=isNaN(n)?null:n;
            }else if(floatFields.includes(h)&&val!==null){
              const n=parseFloat(val);val=isNaN(n)?null:n;
            }
            obj[h]=val;
          });
          return obj;
        });
        if(progressEl){progressEl.style.display='inline';progressEl.value=0;}
        const dbSuccess = await uploadRowsToSupabase(rows,format,pct=>{
          if(progressEl){progressEl.value=pct;}
        });
        if(progressEl){progressEl.style.display='none';progressEl.value=0;}
        if(insertCountEl){
          insertCountEl.textContent = dbSuccess ? `Inserted ${lastInsertCount} rows.` : '';
        }
        if(dbStatusEl){
          if(dbSuccess){
            dbStatusEl.textContent='lineup written to database';
            dbStatusEl.className='status success';
            if(dbQueryEl){
              dbQueryEl.textContent='';
              dbQueryEl.style.display='none';
            }
          }else{
            dbStatusEl.textContent='database failure';
            dbStatusEl.className='status error';
            if(dbQueryEl){
              dbQueryEl.textContent=lastSqlQuery;
              dbQueryEl.style.display='block';
            }
          }
        }
        const teams={};
        rows.forEach(r=>{const key=r['Draft Entry'];if(!teams[key]){teams[key]={tournamentTitle:r['Tournament Title'],entryFee:r['Tournament Entry Fee'],picks:[]};}teams[key].picks.push(r);});
        const teamArr=Object.values(teams);
        teamArr.forEach(team=>{
          team.picks.sort((a,b)=>parseInt(a['Pick Number'],10)-parseInt(b['Pick Number'],10));
          const firstPick=team.picks[0];
          let dateEntered='';
          let draftDate=null;
          if(firstPick&&firstPick['Picked At']){
            const d=new Date(firstPick['Picked At']);
            if(!isNaN(d)){
              draftDate=d;
              const mm=String(d.getMonth()+1).padStart(2,'0');
              const dd=String(d.getDate()).padStart(2,'0');
              const yy=d.getFullYear();
              dateEntered=`${mm}/${dd}/${yy}`;
            }
          }
          team.dateEntered=dateEntered;
          team.draftDate=draftDate;
          const rosterSize=team.picks.length;
          team.rosterSize=rosterSize;
          team.totalRating=team.picks.reduce((sum,p)=>{const canon=canonicalName(`${p['First Name']} ${p['Last Name']}`);const rating=parseFloat(ratingMap[canon]);return sum+(isNaN(rating)?0:rating);},0);
          if(rosterSize===20){
            team.totalRating=team.totalRating*(18/20);
          }
        });
        teamArr.forEach(t=>t.format=format);
        allTeams.push(...teamArr);
        statusEl.textContent='\u2713 Upload Successful';
        statusEl.className='status success';
        localStorage.setItem('bb_lastQuery', lastSqlQuery);
        updateLastQueryDisplay();
        return true;
      }catch(err){
        statusEl.textContent='\u2717 Upload Failure';
        statusEl.className='status error';
        localStorage.setItem('bb_lastQuery', lastSqlQuery);
        updateLastQueryDisplay();
        return false;
      }
    }

    function renderTeams(teams){
      const teamsEl=document.getElementById('teams');
      teamsEl.innerHTML='';
      teamsEl.classList.toggle('list-view', viewMode==='list');

      if(viewMode==='list'){
        const table=document.createElement('table');
        table.className='lineup-table';
        table.innerHTML='<thead><tr><th>Contest</th><th>Date Drafted</th><th>QBs</th><th>RBs</th><th>WRs</th><th>TEs</th><th>Total Rating</th><th>Team Exposure</th></tr></thead>';
        const tbody=document.createElement('tbody');
        teams.forEach(team=>{
          const tr=document.createElement('tr');
          const feeDisp=parseFloat(team.entryFee).toString();
          const contest=`${team.tournamentTitle} - $${feeDisp}`;
          const qbList=team.picks.filter(p=>p['Position']==='QB').map(p=>`<li>${p['First Name']} ${p['Last Name']}</li>`).join('');
          const rbList=team.picks.filter(p=>p['Position']==='RB').map(p=>`<li>${p['First Name']} ${p['Last Name']}</li>`).join('');
          const wrList=team.picks.filter(p=>p['Position']==='WR').map(p=>`<li>${p['First Name']} ${p['Last Name']}</li>`).join('');
          const teList=team.picks.filter(p=>p['Position']==='TE').map(p=>`<li>${p['First Name']} ${p['Last Name']}</li>`).join('');
          const pct=Math.max(0,Math.min(100,((team.totalRating-7.5)/(11-7.5))*100));
          const colors=colorForPct(pct);
          const rating=`<span class="rating-pill" style="background-color:${colors.bg};color:${colors.text};">${pct.toFixed(0)}</span>`;

          const stats={};
          team.picks.forEach(p=>{
            const code=teamMap[p['Team']]||p['Team']||'';
            if(!code) return;
            const canon=canonicalName(`${p['First Name']} ${p['Last Name']}`);
            const rating=parseFloat(ratingMap[canon]);
            if(!stats[code]) stats[code]={count:0,total:0};
            stats[code].count++;
            if(!isNaN(rating)) stats[code].total+=rating;
          });
          const exposure=document.createElement('div');
          exposure.className='team-summary';
          Object.entries(stats)
            .filter(([,v])=>v.count>=2)
            .sort((a,b)=>b[1].count-a[1].count)
            .forEach(([code,{count,total}])=>{
              const item=document.createElement('div');
              item.className='team-count';
              item.title=`Total Rating: ${total.toFixed(2)}`;
              const img=document.createElement('img');
              img.src=`https://www.fantasynerds.com/images/nfl/team_logos/${code}.png`;
              img.className='team-logo';
              img.alt=code;
              img.onerror=()=>{img.style.display='none';};
              const span=document.createElement('span');
              span.textContent=`${count}`;
              item.appendChild(img);
              item.appendChild(span);
              exposure.appendChild(item);
            });

          tr.innerHTML=`<td>${contest}</td><td>${team.dateEntered||''}</td><td><ul>${qbList}</ul></td><td><ul>${rbList}</ul></td><td><ul>${wrList}</ul></td><td><ul>${teList}</ul></td><td>${rating}</td><td></td>`;
          tr.querySelector('td:last-child').appendChild(exposure);
          tbody.appendChild(tr);
        });
        table.appendChild(tbody);
        teamsEl.appendChild(table);
        return;
      }

      teams.forEach(team=>{
        const card=document.createElement('div');
        card.className=`team-card draft-card roster-${team.rosterSize}`;
        const header=document.createElement('h2');
        const icon=document.createElement('img');
        icon.className='icon';
        icon.src='https://encrypted-tbn0.gstatic.com/images?q=tbn:ANd9GcRltuDZN3yIMK1sh9oDF7ykc7HYDeuCGoZ--g&s';
        icon.alt='Underdog icon';
        header.appendChild(icon);
        const feeDisp=parseFloat(team.entryFee).toString();
        const datePart=team.dateEntered?` - Date Entered: ${team.dateEntered}`:'';
        header.append(`${team.tournamentTitle} - $${feeDisp}${datePart} - Total Rating: `);
        const ratingEl=document.createElement('span');
        ratingEl.className='rating-pill';
        const pct=Math.max(0,Math.min(100,((team.totalRating-7.5)/(11-7.5))*100));
        let emojiArr=neutralEmojis;
        if(pct>=66) emojiArr=positiveEmojis;
        else if(pct<34) emojiArr=negativeEmojis;
        const colors=colorForPct(pct);
        ratingEl.textContent=`${pct.toFixed(0)}`;
        ratingEl.style.backgroundColor=colors.bg;
        ratingEl.style.color=colors.text;
        header.appendChild(ratingEl);
        const emojiSpan=document.createElement('span');
        emojiSpan.className='rating-emojis';
        const em1=pickEmoji(emojiArr);
        emojiSpan.textContent=` ${em1}`;
        header.appendChild(emojiSpan);
        const shareBtn=document.createElement('button');
        shareBtn.className='share-btn';
        shareBtn.textContent='Share';
        shareBtn.addEventListener('click',()=>openShareModal(team,card));
        card.appendChild(shareBtn);
        card.appendChild(header);

        const summary=document.createElement('div');
        summary.className='team-summary';
        const stats={};
        team.picks.forEach(p=>{
          const code=teamMap[p["Team"]]||p["Team"]||'';
          if(!code) return;
          const canon=canonicalName(`${p['First Name']} ${p['Last Name']}`);
          const rating=parseFloat(ratingMap[canon]);
          if(!stats[code]) stats[code]={count:0,total:0};
          stats[code].count++;
          if(!isNaN(rating)) stats[code].total+=rating;
        });
        Object.entries(stats)
          .filter(([,v])=>v.count>=2)
          .sort((a,b)=>b[1].count-a[1].count)
          .forEach(([code,{count,total}])=>{
            const item=document.createElement('div');
            item.className='team-count';
            item.title=`Total Rating: ${total.toFixed(2)}`;
            const img=document.createElement('img');
            img.src=`https://www.fantasynerds.com/images/nfl/team_logos/${code}.png`;
            img.className='team-logo';
            img.alt=code;
            img.onerror=()=>{img.style.display='none';};
            const span=document.createElement('span');
            span.textContent=`${count}`;
            item.appendChild(img);
            item.appendChild(span);
            summary.appendChild(item);
          });
        if(summary.childNodes.length){
          const label=document.createElement('small');
          label.className='summary-label';
          label.textContent='Team Exposure';
          card.appendChild(label);
          card.appendChild(summary);
        }
        const table=document.createElement('table');
          table.className="player-table";
        const thead=document.createElement('thead');
        thead.innerHTML='<tr><th>Pick #</th><th>Name</th><th>Team</th><th>Pos</th><th>Rating</th></tr>';
        table.appendChild(thead);
        const tbody=document.createElement('tbody');
        team.picks.forEach(p=>{
          const tr=document.createElement('tr');
          const canon=canonicalName(`${p['First Name']} ${p['Last Name']}`);
          const pos=p["Position"];
          const rating=ratingMap[canon]||'';
          const teamCode=teamMap[p["Team"]]||p["Team"];
          const teamLogo=p["Team"]?`https://www.fantasynerds.com/images/nfl/team_logos/${teamCode}.png`:'';
          const teamCell=teamLogo?`<img src="${teamLogo}" class="team-logo" onerror="this.style.display='none'" alt="${p["Team"]}" />`:'';
          tr.innerHTML=`<td>${p["Pick Number"]}</td><td>${p["First Name"]} ${p["Last Name"]}</td><td>${teamCell}</td><td data-pos="${pos}"><span class="pos-dot"></span>${pos}</td><td>${rating}</td>`;
          tbody.appendChild(tr);
        });
        table.appendChild(tbody);
        card.appendChild(table);
        teamsEl.appendChild(card);
      });
      requestAnimationFrame(standardizeTableHeights);
    }

    function showPage(page){
      const totalPages=Math.max(1,Math.ceil(filteredTeams.length/pageSize));
      if(page<1) page=1;
      if(page>totalPages) page=totalPages;
      currentPage=page;
      const start=(currentPage-1)*pageSize;
      const slice=filteredTeams.slice(start,start+pageSize);
      renderTeams(slice);
      const pagination=document.getElementById('pagination');
      if(!pagination) return;
      pagination.innerHTML='';
      if(totalPages>1){
        const prev=document.createElement('button');
        prev.textContent='Prev';
        prev.disabled=currentPage===1;
        prev.addEventListener('click',()=>showPage(currentPage-1));
        pagination.appendChild(prev);
        const info=document.createElement('span');
        info.textContent=` Page ${currentPage} of ${totalPages} `;
        pagination.appendChild(info);
        const next=document.createElement('button');
        next.textContent='Next';
        next.disabled=currentPage===totalPages;
        next.addEventListener('click',()=>showPage(currentPage+1));
        pagination.appendChild(next);
      }
    }

    function filterAndRender(){
      const selected=[];
      if(document.getElementById('chk-pre').checked) selected.push('pre');
      if(document.getElementById('chk-post').checked) selected.push('post');
      if(document.getElementById('chk-elim').checked) selected.push('elim');
      const startStr=document.getElementById('start-date').value;
      const endStr=document.getElementById('end-date').value;
      const startDate=startStr?new Date(startStr):null;
      const endDate=endStr?new Date(endStr):null;
      const filtered=allTeams.filter(t=>{
        if(!selected.includes(t.format)) return false;
        if(startDate&&t.draftDate&&t.draftDate<startDate) return false;
        if(endDate&&t.draftDate&&t.draftDate>endDate) return false;
        return true;
      });
      filteredTeams=filtered;
      if(sortOrder==='asc') filteredTeams.sort((a,b)=>a.totalRating-b.totalRating);
      else filteredTeams.sort((a,b)=>b.totalRating-a.totalRating);
      showPage(1);
      updateExposureSidebar();
    }

    function computePlayerExposure(teams){
      const map={};
      teams.forEach(team=>{
        const seen=new Set();
        team.picks.forEach(p=>{
          const name=`${p['First Name']} ${p['Last Name']}`;
          const canon=canonicalName(name);
          if(seen.has(canon)) return;
          seen.add(canon);
          if(!map[canon]) map[canon]={name,count:0};
          map[canon].count++;
        });
      });
      const total=teams.length||1;
      return Object.values(map)
        .sort((a,b)=>b.count-a.count||a.name.localeCompare(b.name))
        .map(p=>({name:p.name,count:p.count,pct:((p.count/total)*100).toFixed(1)}));
    }

    function updateExposureSidebar(){
      const tbody=document.querySelector('#exposure-table tbody');
      if(!tbody) return;
      tbody.innerHTML='';
      const exposures=computePlayerExposure(filteredTeams);
      exposures.forEach(p=>{
        const tr=document.createElement('tr');
        tr.innerHTML=`<td>${p.name}</td><td>${p.count}</td><td>${p.pct}%</td>`;
        tbody.appendChild(tr);
      });
    }

    function initExposureDrawer(){
      const fab=document.getElementById('exposureFab');
      const drawer=document.getElementById('exposureDrawer');
      const scrim=document.getElementById('exposureScrim');
      const closeBtn=drawer.querySelector('.drawer-close');
      const main=document.getElementById('portfolio-wrapper');
      const focusSel='button,[href],input,select,textarea,[tabindex]:not([tabindex="-1"])';
      let lastFocused=null;

      function handleKeydown(e){
        if(e.key==='Escape') close();
        if(e.key==='Tab'){
          const items=drawer.querySelectorAll(focusSel);
          if(items.length===0) return;
          const first=items[0];
          const last=items[items.length-1];
          if(e.shiftKey && document.activeElement===first){
            e.preventDefault();
            last.focus();
          }else if(!e.shiftKey && document.activeElement===last){
            e.preventDefault();
            first.focus();
          }
        }
      }

      function open(){
        lastFocused=document.activeElement;
        updateExposureSidebar();
        drawer.classList.add('open');
        drawer.setAttribute('aria-hidden','false');
        scrim.classList.add('show');
        main.setAttribute('aria-hidden','true');
        const first=drawer.querySelector(focusSel);
        if(first) first.focus();
        document.addEventListener('keydown',handleKeydown);
      }

      function close(){
        drawer.classList.remove('open');
        drawer.setAttribute('aria-hidden','true');
        scrim.classList.remove('show');
        main.removeAttribute('aria-hidden');
        document.removeEventListener('keydown',handleKeydown);
        if(lastFocused) fab.focus();
      }

      fab.addEventListener('click',open);
      fab.addEventListener('keydown',e=>{
        if(e.key==='Enter' || e.key===' '){
          e.preventDefault();
          open();
        }
      });
      closeBtn.addEventListener('click',close);
      scrim.addEventListener('click',close);
    }

    function standardizeTableHeights(){
      ['18','20'].forEach(size=>{
        const tables=document.querySelectorAll(`.team-card.roster-${size} table`);
        let max=0;
        tables.forEach(t=>{if(t.offsetHeight>max)max=t.offsetHeight;});
        tables.forEach(t=>{if(max)t.style.height=max+'px';});
      });
    }

    function openShareModal(team,card){
      const pct=Math.max(0,Math.min(100,((team.totalRating-7.5)/(11-7.5))*100)).toFixed(0);
      const clone=card.cloneNode(true);
      const msg=document.createElement('div');
      msg.className='share-message';
      msg.innerHTML=`My lineup scored ${pct}. How do your teams compare? <a href="portfolio.html">See now.</a>`;
      clone.appendChild(msg);
      clone.style.width=card.offsetWidth+'px';
      const showModal=canvas=>{
        try{
          document.getElementById('share-image').src=canvas.toDataURL();
          document.getElementById('share-modal').classList.add('show');
        }catch(err){
          clone.querySelectorAll('img.team-logo').forEach(img=>{
            const abbr=(img.alt||'').slice(0,3).toUpperCase();
            const span=document.createElement('span');
            span.className='team-abbr';
            span.textContent=abbr;
            img.replaceWith(span);
          });
          clone.querySelectorAll('img').forEach(img=>img.remove());
          html2canvas(clone).then(showModal);
        }
      };

      html2canvas(clone,{useCORS:true}).then(showModal);
    }

    document.getElementById('open-modal').addEventListener('click',()=>{
      document.getElementById('upload-modal').classList.add('show');
      if(insertCountEl) insertCountEl.textContent='';
    });

    document.getElementById('upload-done').addEventListener('click',()=>{
      document.getElementById('upload-modal').classList.remove('show');
      if(lastSqlQuery){
        const content=document.getElementById('query-content');
        if(content){
          content.textContent=lastSqlQuery;
        }
        const qmodal=document.getElementById('query-modal');
        if(qmodal) qmodal.classList.add('show');
      }
      updateFormatOptions();
      filterAndRender();
    });

    document.getElementById('query-done').addEventListener('click',()=>{
      document.getElementById('query-modal').classList.remove('show');
    });

    document.getElementById('share-close').addEventListener('click',()=>{
      document.getElementById('share-modal').classList.remove('show');
    });

    document.getElementById('pre-file').addEventListener('change',async e=>{
      if(uploading) return;
      setUploading(true);
      const success=await handleFile(
        e.target.files[0],
        document.getElementById('pre-status'),
        'pre',
        document.getElementById('pre-progress')
      );
      if(success){
        uploadedFormats.pre=true;
        saveUploads();
      }
      updateFormatOptions();
      e.target.value='';
      setUploading(false);
    });
    document.getElementById('post-file').addEventListener('change',async e=>{
      if(uploading) return;
      setUploading(true);
      const success=await handleFile(
        e.target.files[0],
        document.getElementById('post-status'),
        'post',
        document.getElementById('post-progress')
      );
      if(success){
        uploadedFormats.post=true;
        saveUploads();
      }
      updateFormatOptions();
      e.target.value='';
      setUploading(false);
    });
    document.getElementById('elim-file').addEventListener('change',async e=>{
      if(uploading) return;
      setUploading(true);
      const success=await handleFile(
        e.target.files[0],
        document.getElementById('elim-status'),
        'elim',
        document.getElementById('elim-progress')
      );
      if(success){
        uploadedFormats.elim=true;
        saveUploads();
      }
      updateFormatOptions();
      e.target.value='';
      setUploading(false);
    });

    document.getElementById('clear-lineups').addEventListener('click',()=>{
      allTeams.length=0;
      uploadedFormats.pre=false;
      uploadedFormats.post=false;
      uploadedFormats.elim=false;
      localStorage.removeItem('bb_allTeams');
      localStorage.removeItem('bb_uploadedFormats');
      updateFormatOptions();
      filterAndRender();
    });

    loadUploads();
    updateFormatOptions();
    ratingsPromise.then(filterAndRender);

    document.getElementById('chk-pre').addEventListener('change',filterAndRender);
    document.getElementById('chk-post').addEventListener('change',filterAndRender);
    document.getElementById('chk-elim').addEventListener('change',filterAndRender);
    document.getElementById('start-date').addEventListener('change',filterAndRender);
    document.getElementById('end-date').addEventListener('change',filterAndRender);
    document.getElementById('sort-toggle').addEventListener('click',()=>{
      sortOrder = sortOrder==='desc' ? 'asc' : 'desc';
      document.getElementById('sort-toggle').innerHTML = sortOrder==='desc' ? '&#8595;' : '&#8593;';
      filterAndRender();
    });
    document.getElementById('view-card').addEventListener('click',()=>{
      viewMode='card';
      pageSize=21;
      document.getElementById('view-card').classList.add('selected');
      document.getElementById('view-list').classList.remove('selected');
      filterAndRender();
    });
    document.getElementById('view-list').addEventListener('click',()=>{
      viewMode='list';
      pageSize=100;
      document.getElementById('view-list').classList.add('selected');
      document.getElementById('view-card').classList.remove('selected');
      filterAndRender();
    });

    initExposureDrawer();
  </script>
</body>
</html>
